name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.1.0)'
        required: true
        default: '2.1.0'
      release_title:
        description: 'Release title'
        required: true
        default: 'å›¾å½¢è®¾å¤‡é—®é¢˜è§£å†³æ–¹æ¡ˆ v2.1.0'
      prerelease:
        description: 'Is this a prerelease?'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build Windows version
      run: dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o ./publish/windows
      
    - name: Build Linux version
      run: dotnet publish -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true -o ./publish/linux
      
    - name: Create Windows zip
      run: Compress-Archive -Path ./publish/windows/* -DestinationPath ./MCGame-Windows-x64.zip
      
    - name: Create Linux tar.gz
      run: tar -czf ./MCGame-Linux-x64.tar.gz -C ./publish/linux .
      
    - name: Generate Release Notes
      id: release_notes
      run: |
        $tag = "${{ github.ref_name }}"
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $tag = "v${{ github.event.inputs.version }}"
        }
        
        echo "TAG_NAME=$tag" >> $env:GITHUB_OUTPUT
        
        $notes = @"
        # MCGame Release $tag
        
        ## ğŸ‰ ä¸»è¦ç‰¹æ€§
        
        ### å›¾å½¢è®¾å¤‡é—®é¢˜è§£å†³
        - âœ… å®ç°å¤šç§å¯åŠ¨æ¨¡å¼ï¼ˆæ­£å¸¸/è½¯ä»¶æ¸²æŸ“/æ— å¤´æ¨¡å¼ï¼‰
        - âœ… è‡ªåŠ¨ç¯å¢ƒå˜é‡é…ç½®
        - âœ… æ™ºèƒ½é™çº§æœºåˆ¶
        - âœ… è¯¦ç»†çš„æ•…éšœæ’é™¤æ—¥å¿—
        
        ### SpriteBatch Begin/Endä¿®å¤
        - âœ… ä¿®å¤UIæ¸²æŸ“æ—¶çš„Begin/Endä¸åŒ¹é…é—®é¢˜
        - âœ… è§£å†³åå­—å‡†å¿ƒæ¸²æŸ“é”™è¯¯
        - âœ… é¿å…åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­åŠ è½½å†…å®¹æ–‡ä»¶
        - âœ… ç¡®ä¿SpriteBatchæ­£ç¡®é…å¯¹ä½¿ç”¨
        
        ### æ–°å¢åŠŸèƒ½
        - ğŸš€ **æ— å¤´æ¨¡å¼**: æ”¯æŒåœ¨æ— å›¾å½¢è®¾å¤‡ç¯å¢ƒä¸‹è¿è¡Œ
        - ğŸ”§ **è½¯ä»¶æ¸²æŸ“**: å¼ºåˆ¶ä½¿ç”¨è½¯ä»¶æ¸²æŸ“è§£å†³å…¼å®¹æ€§é—®é¢˜
        - ğŸ“Š **ç¯å¢ƒæ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹ç¡¬ä»¶åŠ é€Ÿæ”¯æŒ
        - ğŸ› ï¸ **å¯åŠ¨è„šæœ¬**: ä¾¿æ·çš„å¯åŠ¨æ¨¡å¼é€‰æ‹©å™¨
        
        ### å‘½ä»¤è¡Œå‚æ•°æ”¯æŒ
        - `--headless` æˆ– `-h`: æ— å¤´æ¨¡å¼
        - `--software` æˆ– `-s`: å¼ºåˆ¶è½¯ä»¶æ¸²æŸ“
        
        ## ğŸ® ä½¿ç”¨æ–¹æ³•
        
        ### æ¨èæ–¹å¼
        ```bash
        å¯åŠ¨MCGame.bat
        ```
        
        ### ç›´æ¥è¿è¡Œ
        ```bash
        MCGame.exe              # æ­£å¸¸æ¨¡å¼
        MCGame.exe --software   # è½¯ä»¶æ¸²æŸ“
        MCGame.exe --headless   # æ— å¤´æ¨¡å¼
        ```
        
        ## ğŸ”§ ä¿®å¤çš„é—®é¢˜
        - ä¿®å¤ `NoSuitableGraphicsDeviceException` é”™è¯¯
        - ä¿®å¤ `InvalidOperationException: Begin cannot be called again until End has been successfully called`
        - è§£å†³UIæ¸²æŸ“æ—¶çš„SpriteBatch Begin/Endä¸åŒ¹é…é—®é¢˜
        - ä¿®å¤åå­—å‡†å¿ƒæ¸²æŸ“æ—¶çš„å†…å®¹åŠ è½½é”™è¯¯
        - æ”¯æŒåœ¨å„ç§å›¾å½¢ç¯å¢ƒä¸‹å¯åŠ¨
        - è‡ªåŠ¨é™çº§åˆ°å…¼å®¹æ¨¡å¼
        - å®Œå–„çš„é”™è¯¯æ—¥å¿—è®°å½•
        
        ## ğŸ“Š å…¼å®¹æ€§
        - Windows 10/11 (x64)
        - Linux (x64)
        - è™šæ‹Ÿæœºç¯å¢ƒ
        - æ— å›¾å½¢è®¾å¤‡ç¯å¢ƒ
        
        ## ğŸ“¦ åŒ…å«æ–‡ä»¶
        - MCGame.exe (Windowså•æ–‡ä»¶å¯æ‰§è¡Œç¨‹åº)
        - å¯åŠ¨MCGame.bat (ä¾¿æ·å¯åŠ¨è„šæœ¬)
        - å®Œæ•´çš„æºä»£ç å’Œæ–‡æ¡£
        
        ## ğŸ® åŸºç¡€æ§åˆ¶
        - WASD: Move
        - Mouse: Look around
        - Space: Jump
        - Shift: Sprint
        - F: Toggle fly mode
        - F3: Toggle debug info
        - F11: Toggle fullscreen
        - +/-: Adjust render distance
        - R: Regenerate world
        
        ## ğŸ“ è¯¦ç»†ä¿¡æ¯
        - æŸ¥çœ‹ [GRAPHICS_ISSUE_DIAGNOSIS.md](https://github.com/ModerRAS/MCGame/blob/master/GRAPHICS_ISSUE_DIAGNOSIS.md) äº†è§£æŠ€æœ¯ç»†èŠ‚
        - æŸ¥çœ‹ [README_GRAPHICS_SOLUTION.md](https://github.com/ModerRAS/MCGame/blob/master/README_GRAPHICS_SOLUTION.md) è·å–ä½¿ç”¨æŒ‡å—
        
        ---
        
        **æç¤º**: å¦‚æœé‡åˆ°å¯åŠ¨é—®é¢˜ï¼Œè¯·å°è¯•ä½¿ç”¨å¯åŠ¨è„šæœ¬é€‰æ‹©ä¸åŒçš„å¯åŠ¨æ¨¡å¼ï¼Œæˆ–æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†ä¿¡æ¯ã€‚
        
        ## ğŸ—ï¸ æŠ€æœ¯æ¶æ„
        - Built with MonoGame 3.8.1.303
        - .NET 9.0 Runtime
        - Custom Graphics Device Manager
        - Environment Configuration System
        - Headless Mode Support
        - Advanced Logging System
        "@
        
        $notes | Out-File -FilePath ./RELEASE_NOTES.md -Encoding UTF8
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_notes.outputs.TAG_NAME }}
        name: ${{ github.event.inputs.release_title || format('Release {0}', steps.release_notes.outputs.TAG_NAME) }}
        body_path: ./RELEASE_NOTES.md
        draft: false
        prerelease: ${{ github.event.inputs.prerelease || false }}
        files: |
          ./MCGame-Windows-x64.zip
          ./MCGame-Linux-x64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}